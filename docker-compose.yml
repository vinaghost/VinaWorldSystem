services:
  webfrontend:
     image: ${DOCKER_REGISTRY-}webfrontend
     depends_on:
        webapi:
          condition: service_healthy
     build:
        context: .
        dockerfile: WebFrontEnd/Dockerfile
     profiles:
        - donotstart

  webapi:
     image: ${DOCKER_REGISTRY-}webapi
     depends_on:
        redis:
          condition: service_started
     healthcheck:
        test: curl --fail http://webapi:8080/Counter || exit 1
        interval: 20s
        timeout: 20s
        retries: 5
     build:
        context: .
        dockerfile: WebAPI/Dockerfile
     environment:
        CONNECTION_STRING: "Server=mysql;User=root;Password=${MYSQL_ROOT_PASSWORD};Database=TravianDb"
        AUTH0_AUTHORITY: ${AUTH0_AUTHORITY}
        AUTH0_AUDIENCE: ${AUTH0_AUDIENCE}
        REDIS_URL: "redis:6379"
        REDIS_INSTANCE_NAME: "RedisTravian"
        AUTH0_DOMAIN: ${AUTH0_DOMAIN}
        AUTH0_CLIENT_ID: ${AUTH0_CLIENT_ID}
        AUTH0_CLIENT_SECRET: ${AUTH0_CLIENT_SECRET}

  redis:
     image: redis
     command: ["redis-server", "--appendonly", "yes"]
     volumes:
        - redis_data:/data
  mysql:
     image: mysql
     environment:
        MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
     volumes:
        - mysql_data:/var/lib/mysql
volumes:
  redis_data:
  mysql_data: